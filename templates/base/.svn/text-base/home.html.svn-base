<!-- A user's home page. Shown when authenticated -->

<html xmlns:fb="http://www.facebook.com/2008/fbml"><head>
    <meta charset=UTF-8>
	<title>PopCore</title>
	<script type="text/javascript">if (window.location.hash == '#_=_')window.location.hash = '';</script>
	<link type="text/css" href="{{ STATIC_URL }}css/july25/jquery-ui.custom.css" rel="stylesheet" />
    <link type="text/css" href="{{ STATIC_URL }}css/style.css" rel="stylesheet" />
    <link type="text/css" href="{{ STATIC_URL }}css/jquery.qtip.css" rel="stylesheet" />
	
	
</head><body>
<div id="container">
<div id="fb-root"></div>
<div id="header">
	<div id="headerImg">
	    <div id="searchbar" class="medium-font">
	        <input id="search" class="ui-corner-all" value="Search stuff..." />
	        <img class="throbber" src="{{ STATIC_URL }}images/loading.gif" alt="Loading..." style="display:none">
		    <input type="hidden" id="search-id"/>
        	<a href="#">&nbsp;</a>
        </div>
		<div id="switchbox" style="width:450px">
            <div id="switchbox_overlay" style="position:absolute; top:69px; right:-85px;">
                <div id="items_eq" style="float:left; padding:top:50px;">
	                <div id="movies_eq">{{ uiconfig.movie_slider }}</div>
	                <div id="music_eq">{{ uiconfig.music_slider }}</div>
	                <div id="tvshows_eq">{{ uiconfig.tv_slider }}</div>
	                <div id="books_eq">{{ uiconfig.book_slider }}</div>
                </div>

                <div id="recency_chooser" style="float:right; top:-25px; left:-49px;">
                </div>

                <div id="nowknob_overlay" style="width:120px; height:70px;position:relative; left:139px">
                    <div id="nowknob1" style="width:33%; height:100%; float:left; position:absolute"></div>
                    <div id="nowknob2" style="width:33%; height:100%;float:left; position:absolute; left: 40px;"></div>
                    <div id="nowknob3" style="width:33%; height:100%;float:left; position:absolute; left:80px;"></div>
                </div>
            </div>	

		</div>
	</div>
</div>

    <div id="leftbar">
        <div id="realtime">
        <ul style="color:white"> </ul>
        
        </div>
        <p id="vis_heading" class="module-heading">Hot in your network</p>
        <div id="visualization">
            <div class="tag-cloud" id="default_tag_cloud" style="overflow:hidden"></div>
        </div>

    </div>


<div id="main">
    <div class="scroll">
        <div class="direction">
            <img src="{{ STATIC_URL}}images/up.png"/>
        </div>
    </div>
    
    <div id="contents">
        
        <div id="hello_user">
            <div style="float:left">Hello {{ name }}</div>
	        <div style="float:right">
	            <a href="{% url django.contrib.auth.views.logout %}?next={% url base.views.landing %}" style="float:right">logout</a>
	            <button id="back_to_recs" class="ui-helper-hidden" style="font-size:0.8em; display:none">Back to Recommendations</button>
	        </div>
        </div>
        <br/>
        <ul class="grid" id="default_items_list">		
	    </ul>	
	   <!-- 	    
        <div id="log" class="ui-helper-hidden">
	        <div id="log-content" style=" overflow: auto;"></div>
	        <div id="suggest-input" style="overflow: hidden;" class="suggest-friends-block">
		        <button class="suggestb float-right">Suggest To</button>
		        <div class="formWrap">
		            <form class="messageForm" action="#">
			            <div class="friends ui-helper-clearfix float-left ui-corner-all">
				            <input class="to" type="text">
			            </div>
		            </form>
		        </div>
	        </div>
        </div>-->
        <div style="clear:both; text-align:right;"><button id="feedback_b">Give feedback</a></div>
    </div>
    
    <div class="scroll">
        <div class="direction">
            <img src="{{ STATIC_URL}}images/down.png"/>
        </div>
    </div>
</div>




    <div id="rightbar">
        <div id="notify_div">
        </div>
        <div id="profile">
        </div>

        <div id="slider" style="position:relative">
            <img src="{{ STATIC_URL}}images/button2.png" width="180"/>
            <div id="genre_headings" style="position:absolute; top:190px; left:43px">
                Popular<br/>
                Close Friends<br/>
                Trending<br/>
                Acclaimed<br/>
            </div>
            <div id="genre_tabs" style="position:absolute; top:150px; left:38px;">
                <ul style="margin-bottom: 50px;">
                    <li><a href="#gtabs-1" style="width:40px; height:8px; cursor:default;"></a></li>
                    <li><a href="#gtabs-2" style="width:50px; height:8px;cursor:default;"></a></li>
	            </ul>
                <div id="gtabs-1">
                    <div id="genre_slider">
                        <div id="popularity_eq">{{ uiconfig.popular_slider }}</div>
	                    <div id="closefriends_eq">{{ uiconfig.closef_slider }}</div>
	                    <div id="trending_eq">{{ uiconfig.random_slider }}</div>
	                    <div id="acclaimed_eq">{{ uiconfig.acclaim_slider }}</div>
	                </div>
                </div>
                <!--
                <div id="gtabs-2">
                    <div id="people_slider">
                        <div>70</div>
	                    <div>77</div>
	                    <div>55</div>
	                    <div>65</div>
	                </div>
                </div>-->
            </div>

        </div>
        <div id="Qbutton">
            <div class="droppable sortable" id="queue_area" style="height:136px;width:130px;text-align:center; vertical-align:center; margin:40px;border:none; background:none"></div>

        </div>

    </div>

</div>
<!--
<div id="switchbox_overlay">
    <div id="items_eq" class="ui-helper-hidden">
	    <div id="movies_eq">88</div>
	    <div id="books_eq">77</div>
	    <div id="music_eq">55</div>
	    <div id="tvshows_eq">65</div>
    </div>

    <div id="recency_chooser">
    </div>

    <div id="nowknob_overlay" style="width:120px; height:70px;">
        <div id="nowknob1" style="width:30%; height:100%; float:left"></div>
        <div id="nowknowb2" style="width:30%; height:100%;float:left"></div>
        <div id="nowknob3" style="width:30%; height:100%;float:left"></div>
    </div>
</div>	
-->

	
	
<div id="suggest_dialog" class="ui-helper-hidden" title="Suggest">
	<span class="validateTips">Share a message:</span>

	<fieldset>
	    <legend> Share </legend>
	    <form>
	    <div class="friends ui-helper-clearfix float-left ui-corner-all">
	        <label for="tofr">Enter one or more friends </label><br/>
	         <input name="tofr" class="to text ui-widget-content ui-corner-all" type="text">
	    </div>
	    <br />
		<label for="Message">Message</label>
		<br/>
		<textarea rows="3" cols="20" name="message" id="message" class="text ui-widget-content ui-corner-all" >></textarea>
		</form>
	</fieldset>
</div>
	
<div id="dialog_sharefb" title="Not yet on PopCore" class="ui-helper-hidden">
	<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>Share on Facebook instead?</p>
</div>

<div id="dialog_popcoreintro" title="A few quick tips..." class="ui-helper-hidden">
    <div style="float:left; width:26%; padding:20px;"><span class="ui-icon ui-icon-clock" style="float:left; margin:0 7px 60px 0;"></span>Wait for the recommendations to load. Please be patient, this may take anywhere from a few to 10-15 seconds.</div>
    <div style="float:left; width:26%; padding:20px;"><span class="ui-icon ui-icon-note" style="float:left; margin:0 7px 60px 0;"></span>The main content pane shows you your recommendations. Click on each recommendation card to flip it. You can click on the item name below to get more details.</div>
    <div style="float:left; width:26%; padding:20px;"><span class="ui-icon ui-icon-star" style="float:left; margin:0 7px 60px 0;"></span>Tune your recommendations by following the sliders above and on the right. Enjoy, and share the goodness with your friends!</div>
    <div style="clear:both"></div>
</div>


<div id="dialog_notimplemented" title="Wait a bit more..." class="ui-helper-hidden">
	<p><span class="ui-icon ui-icon-wrench" style="float:left; margin:0 7px 20px 0;"></span>Sorry, this feature is currently not available. Keep checking back! </p>
</div>

<div id="queue-confirm" title="Added to Queue">
	<p>
		<span class="ui-icon ui-icon-circle-check" style="float:left; margin:0 7px 50px 0;"></span>
		Item successfully added.
	</p>
</div>

<div id="moreinfo_box" style="display:none">
    <div style="float:left;width:66%" id="moreinfo_contents">
    </div>
    <div style="float:right;width:33%">
        <p><span class="fr-likes"></span> friends like this</p>
    </div>
</div>

<!-- Javascript follows now. -->
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-ui.min.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-css-transform.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/rotate3Di.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.raty.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery.qtip.pack.js"></script>
<script type="text/javascript" src="{{ STATIC_URL }}js/functions.js"></script>
<script type="text/javascript">
	var content = document.getElementById('default_items_list');
	var dumpText = function(text){
		content.innerHTML = content.innerHTML + text;
	};
	function mySideChange(front) {
	    if (front) {
	        $(this).children('div:first').hide();
	        $(this).children('div.item-poster').show();
	    } else {
	        $(this).children('div.item-poster').hide();
	        $(this).children('div:first').show();
	    }
	}

	function myComplete() {
	    //$('#ex7').css('backgroundColor', '#f00');
	}

	// Function to get random number upto m
	// http://roshanbh.com.np/2008/09/get-random-number-range-two-numbers-javascript.html
	function randomXToY(minVal,maxVal,floatVal) {
		var randVal = minVal+(Math.random()*(maxVal-minVal));
		return typeof floatVal=='undefined'?Math.round(randVal):randVal.toFixed(floatVal);
	}
	var dragging = false;
	
	// TODO snapping to grids/objects
	var makeItemsDraggable = function() {
		/*$(".draggable").draggable({
			connectToSortable: ".sortable",
			revert:"invalid",
			containment: "#middlecontainer",
			scroll: true,
			opacity: 0.7
		});*/
		$("#default_items_list").sortable({
			connectWith: "#queue_area",
			//containment: "#middlecontainer",
			scroll: true,
			opacity: 0.8,
			revert: "invalid",
			snap: true,
			start: 	function(event, ui) {
						dragging = true;
					},
			stop:	function(event,ui) {
						dragging=false;
					}
		});
		$("#default_items_list li").mouseup(function(e){
			//alert(e.target);
			if (!dragging && ( e.target==this.getElementsByClassName('item-poster')[0] || e.target==this.getElementsByClassName('item-poster-back')[0] )) {
				$(this).rotate3Di('toggle', 'normal', {sideChange: mySideChange, complete: myComplete});
			}
			return true
		});
	};
	
	function rotateItemElement($el){
	    var tempVal = Math.round(Math.random());
		if(tempVal == 1) {
			var rotDegrees = randomXToY(330, 360); // rotate left
		} else {
			var rotDegrees = randomXToY(0, 30); // rotate right
		}
		
		var position = $el.parent().offset();
		var wiw = $el.parent().width();
		var wih = $el.parent().height();
		
		var leftpos = Math.random()*(wiw - $el.width()) + position.left;
		var toppos = Math.random()*(wih - position.top) + position.top;
		var cssObj = { 'left' : leftpos,
			'top' : toppos,
			'-webkit-transform' : 'rotate('+ rotDegrees +'deg)',  // safari only
			'-moz-transform' : 'rotate('+ rotDegrees +'deg)',  // firefox only
			'transform' : 'rotate('+ rotDegrees +'deg)'  // added in case CSS3 is standard
	    };
		
		$el.css(cssObj);
		//$el.css('transform', 'rotate('+ rotDegrees +'deg)');
	}
	function powerItemButtons($element, hideOnQueue) {
	   $element.each(function () {
            /*
			*/
			
			var item_element = $(this);
			$(this).find('.add-queue-button').each(function(){
			    var item_name=$(this).parent().next().next().text();
                var item_link = $(this).parent().next().next().attr('href');
                var item_id = $(this).parent().next().next().attr('name');
                var pic_url=$(this).parent().next().css('background-image')
                pic_url = pic_url.substring(4,pic_url.length-1);
                var item_type=$(this).parent().next().attr('name');
			    $(this).click(function(event) {
			        //$("#queue_area").trigger("drop");
			        $.get("{% url base.realtime.addtoQueue %}", {'item_id': item_id, 'item_link':item_link, 'item_name':item_name, 'item_pic':pic_url,'item_type':item_type}, function(resp) {
			            if (resp == "1") {
			                $( "#queue-confirm" ).dialog('open');
			                if (hideOnQueue){
			                    item_element.hide();			        
			                }
			            }
			        });
                    //item_element.animate({left: "+=50"}, 1000, function(){alert("Done");});
			    });
			});
			
			$(this).find('.rec-button').each(function(){
			    var item_name=$(this).parent().next().next().text();
                var item_link = $(this).parent().next().next().attr('href');
                var item_id = $(this).parent().next().next().attr('name');
			    
			    var pic_url=$(this).parent().next().css('background-image')
                pic_url = pic_url.substring(4,pic_url.length-1);
                        
                //var pic_url=$(this).parent().next().attr('src');
			    $(this).qtip(
                        {
                        content: {
                        text: '<img class="throbber" src="{{ STATIC_URL }}images/loading.gif" alt="Loading..." />',
                        ajax: {
                            url: '{% url recommender.views.suggestPeople %}',
                            type: 'GET',
                            data: {'item_id':item_id},
                            success: function(data, status) {
            				    this.set('content.text', data);
            				    
            				    $('.people-suggestor button'). each(function() {
            				        $(this).button();
            				        $(this).click(function()  {
			                            var item_pic = "{{ STATIC_URL }}images/popcore_logo.jpg";;
			                            var fr_id = $(this).attr('id');
			                            var friend = $(this).children("span:first").text();
			                            
			                            
			                             $.get('{% url base.views.get_imageshack %}', {img_url: pic_url}, function(resp){
	                                            //alert(resp);
	                                            //$('#ajax_placeholder').attr('src', resp);
	                                            item_pic = resp;

	                                    });
	                                     $('#suggest_dialog').data('item_info', {'name':item_name, 'id':item_id, 'link':item_link, 'caption':"", 'picture':item_pic, 'fr_id':fr_id, 'friend':friend});
	                                            
			                             $('#suggest_dialog').dialog("open");
            				        });
            				    });
            				   
                			}
                            
                        },
                        title: {
                           text: 'Choose Friends', // Give the tooltip a title using each elements text
                           button: 'Close' // Show a close link in the title
                        }
                     },
                     position: {
                        corner: {
                           target: 'bottomMiddle', // Position the tooltip above the link
                           tooltip: 'topMiddle'
                        },
                        adjust: {
                           screen: true // Keep the tooltip on-screen at all times
                        }
                     },
                     show: { 
                        event: 'click',
                        solo:true,
                     },
                     hide: {
			            event: 'click',
			            target: $('button'),
			            fixed: true
		             }, 
		             style: {
                        tip: true, // Apply a speech bubble tip to the tooltip at the designated tooltip corner
                        border: {
                           width: 0,
                           radius: 4
                        },
                        widget:true,
                        //width: 170 // Set the tooltip width
                     },
                     events: {
		                render: function(event, api) {
			                api.elements.tooltip.click(function(){$(this).hide();});
		                }
	                }
                  });
             });
             
             $(this).find(".more-info").click(function(){
                $('#moreinfo_contents').html("");
                $.get("{% url base.views.getMoreInfo %}",{'category':$(this).parent().next().attr('name'), 'name':$(this).parent().next().next().text()}, function(resp){
                    resp = resp.replace(/&lt;/g,"<");
                    resp = resp.replace(/&gt;/g,">");
                    resp = resp.replace(/&quot;/g,'"');
                    resp = resp.replace(/&amp;/g,'"');
                    //alert(resp);
                    
                    $('#moreinfo_contents').html(resp);
                });
                $("#default_items_list > li").css('visibility','visible');
                $(".card-stack").hide();
                $('#moreinfo_box').hide();
                
                
                row_elements = new Array();
                curr_el = item_element.prev();
                final_top = item_element.position().top
                final_left = item_element.position().left;
                while(curr_el.position() !=null){
                    if (curr_el.position().top != item_element.position().top)
                        break;
                    final_left=curr_el.position().left;
                    row_elements.push(curr_el);
                    curr_el = curr_el.prev();
                    //alert(curr_el.attr('class'));
                }
                curr_el = item_element.next();
                while(curr_el.position() !=null){
                    if (curr_el.position().top != item_element.position().top)
                        break;
                    row_elements.push(curr_el);
                    curr_el = curr_el.next();
                }
                row_elements.push(item_element);
                $default_items_div = row_elements[0].parent();
                for(var i=0; i<row_elements.length; i++){
                    var $img_div = row_elements[i].children(".item-poster:first").clone();
                    $img_div.addClass('card-stack');
                    var cssObj = {
                        'width':'100px',
                        'left': final_left+'px',
                        'top': final_top+'px',
                        'position':'absolute',
                        'display':'block'
                    };  
                    
                    $img_div.click(function(){
                        $("#default_items_list > li").css('visibility','visible');
                        $(".card-stack").hide();
                        $('#moreinfo_box').hide();
                    });
                    $('body').append($img_div);
                    rotateItemElement($img_div);
                    $img_div.css(cssObj);
                    row_elements[i].css('visibility','hidden');
                }
                
                $button_span = item_element.children('div:first').clone();
                $('#moreinfo_box').find('.fr-likes').text($button_span.children('a:first').attr('name'));
                $('#moreinfo_box').children('div:last').children('div').remove();
                
                $button_span.children('a:first').remove();
                $button_span.css('padding-top','0px');
                $('#moreinfo_box').children('div:last').append($button_span);
                var cssObj = {
                    'width':'500px',
                    'left': (final_left+140)+'px',
                    'top': final_top+'px',
                    'position':'absolute',
                    'display':'block'
                };
                $('#moreinfo_box').css(cssObj);
             });
		});
	}
    function pick(arg, def) {
        return (typeof arg == 'undefined' ? def : arg);
}
	function getCurrentConfig(config ) {
	    var newconfig = new Object;
	    newconfig.maxitems = pick(config.maxitems, {{ uiconfig.max_items }});
	    newconfig.category = pick(config.category, false);
	    newconfig.movieseq = pick(config.movieseq, $('#movies_eq').slider("value"));
	    newconfig.musiceq = pick(config.musiceq, $('#music_eq').slider("value"));
	    newconfig.bookseq = pick(config.bookseq, $('#books_eq').slider("value"));
	    newconfig.tvshowseq = pick(config.tvshowseq, $('#tvshows_eq').slider("value"));
	    newconfig.recency = pick(config.recency, $('#recency_chooser').data('recency'));
 	    newconfig.popularity = pick(config.popularity, $('#popularity_eq').slider("value"));
 	    newconfig.closefriends = pick(config.closefriends, $('#closefriends_eq').slider("value"));
 	    newconfig.acclaimed = pick(config.acclaimed, $('#acclaimed_eq').slider("value"));
 	    newconfig.trending = pick(config.trending, $('#trending_eq').slider("value"));
	    newconfig.algorithm = pick(config.algorithm, "random");
	    if (newconfig.category == false)
	        delete newconfig.category;
	    return newconfig;
	}
	var state = 0;
	var loading_text = "Loading...";
	function showUpdatedItems(config, initial_processing ) {
	    var loadingsign = "<li style='text-align:center'><span><img src='{{ STATIC_URL }}images/loading.gif' style='border:none' />"+loading_text+"</span></li>";
	    if(pick(initial_processing,false))
	        $("#default_items_list").prepend(loadingsign);
	    else
	        $("#default_items_list").html(loadingsign);
	    $("#back_to_recs").hide();
	    $.ajax({
	        url: "{% url recommender.views.content %}", 
	        data: config,
	        success:  function (ret_html) {
	            
	            if (ret_html.indexOf("Processing") == 0) {
	                loading_text = "";
	                if (state == 0)
	                    $("#default_items_list").html("<span>Fetching data from facebook</span>");
	                else if (state == 1)
	                    $("#default_items_list").html("Processing your profile information");
	                else if (state==2)
	                    $("#default_items_list").html("Processing your friends");
	                else if (state>=3)
	                    $("#default_items_list").html("Computing recommendations");
	                state = state + 1;
	                showUpdatedItems(config, true);
	                return;
	            }
	            else {
	                $("#default_items_list").html(ret_html);
	                makeItemsDraggable();
	                powerItemButtons($("#default_items_list li"),true);
	                if (typeof FB !== 'undefined') {
                        FB.XFBML.parse(document.getElementById('default_items_list'));
                    }
                    
                    $('.stars-wrapper2').raty({
                            path: '{{ STATIC_URL}}images/ratings/',
                            half:true,
        
                            hintList: ['very bad', 'bad', 'average', 'good', 'brilliant'],
                            click: function(score, evt) {
                                item_id = $(this).parent().parent().next().next().attr('name')
                                //alert(item_id);
                                $.get("{% url  recommender.views.storeItemRating %}", {'item_id':item_id, 'score':score},function(){
                                    console.log("Stored rating");
                                })
                                //evt.stopPropagation();
                               // return false;
                            }
                    });
                }
            },
            error: function() {
                $("#default_items_list").html("An error occured. <a href='#' id='error_content'>Try again.</a>");
                 $("#error_content").click(function(){
                    config = getCurrentConfig({});
                    showUpdatedItems(config);
                });
            }               
	
	    });
	}
var updates_arr=[];
var isUpdateRunning = false;
function poll(){
    //alert("Polling");
    
    $.ajax({ url: "{% url base.realtime.notify %}", success: function(data){
        //Update the buzz ticker
        var shown_updates = [];
        $("#realtime >ul li").each(function(){
            shown_updates.push(this.id)
        });
        //alert(shown_updates[0]);
        //alert($(data).attr('id'));
        $(data).each(function(){
            //var items_onscreen = $('#realtime').data('items_shown');
            if (jQuery.inArray(this.id,shown_updates) == -1){
                //$("#realtime > ul").prepend($(this));  
                updates_arr.push($(this));
                //$('#realtime').data('items_shown',items_onscreen+1);  
        	}
        });
        if (!isUpdateRunning){
        	isUpdateRunning = true;
        	updateRealtimeText();
        	
       	}
        

    }, dataType: "text" });
}

function updateRealtimeText(){
	if (updates_arr.length == 0){
		isUpdateRunning = false;
		return;
	}
	$("#realtime > ul").prepend(updates_arr.shift()); 
	setInterval(updateRealtimeText,3000);
}

function showItemInMainScreen(returned_html) {
    $("#default_items_list").html(returned_html);
    powerItemButtons($("#default_items_list div"),false);
    $("#log").show();
    if (typeof FB !== 'undefined') {
        FB.XFBML.parse(document.getElementById('default_items_list'));
    }
    $('.stars-wrapper2').raty({
        path: '{{ STATIC_URL}}images/ratings/',
        half: true,
        hintList: ['bad', 'poor', 'regular', 'good', 'brilliant'],
        click: function(score, evt) {
            //alert("Yo");
            ;
        }
    });
}

$(".ticker-item").live('click', function(){
    var loadingsign = "<li style='text-align:center'><span><img src='{{ STATIC_URL }}images/loading.gif' style='border:none' /> Loading... </span></li>";
    $("#default_items_list").html(loadingsign);
    $('#back_to_recs').show();
	$.get("{% url recommender.views.showItem %}", {'id':$(this).attr('name'),'name': $(this).text(),'category': $(this).attr('type')}, function(returned_html) {
	    showItemInMainScreen(returned_html);
        
    });
});

$(document).ready(function() {  
    //Required for raty plugin to work
	$('body').data('raty_id_counter',0);
	$('#realtime').data('items_shown',0);
    $('a').attr('target', '_blank');
    $('#recency_chooser').data('recency','{{ uiconfig.recency }}');
    
    $("button").button();
    $( "#dialog_popcoreintro" ).dialog({
		resizable: false,
		height:250,
		width: 750,
		buttons: {
			"Let's start!": function() {
				$( this ).dialog( "close" );
			}
			
		}
	});
    
    $("#back_to_recs").click(function(){
        $(this).hide();
        config = getCurrentConfig({algorithm: "random"});
	    showUpdatedItems(config);
    }); 
    $('#recency_chooser').speedometer({percentage:50});
	
	//positionOverlays();
    
    $('#profile').click(function() {
        $.get("{% url base.views.view_profile %}", function(ret_html) {
            $("#default_items_list").html(ret_html);
        });
    });
    
    $('#notify_div').click(function() {
        $.get("{% url base.views.view_notifications %}", function(ret_html) {
            $("#default_items_list").html(ret_html);
        });
    });
    $( "#items_eq > div" ).each(function() {
		// read initial values from markup and remove that
		var value = parseInt( $( this ).text(), 10 );
		$( this ).empty().slider({
			value: value,
			range: "min",
			animate: true,
			orientation: "horizontal",
			change: function( event, ui) {
			    config = getCurrentConfig({algorithm: "random"});
			    showUpdatedItems(config);
			    
			}
		});
	});

	$("#item_type_chooser").buttonset();
	$("#item_type_chooser > input").each (function() { 
	    $(this).data('select_flag', false);
	    if ($(this).is(":checked")) {
	        $(this).data('select_flag', true);
	        
	     }
	    $(this).click(function() {
	        if ($(this).data('select_flag')) {
	            $(this).attr('checked', false);
	            $(this).button('refresh');
	            $(this).data('select_flag', false);
	            showUpdatedItems(getCurrentConfig({max_items:20}));
	        } else {
	            $(this).data('select_flag', true);
	            showUpdatedItems(getCurrentConfig({ category: $(this).attr('id'), max_items:20}));
	        }
	    });
	});
	
	
    
	$( "#genre_tabs" ).tabs({
        select: function(event, ui) { 
            event.preventDefault();
            /*var index = ui.index + 2;
            $("#slider").children("img:first").attr('src', '{{ STATIC_URL }}images/button'+index+'.png');
            if (ui.index == 0) 
                $("#slider #genre_headings").html("Popular<br/>Trending<br/>Acclaimed<br/>Surprise Me!<br/>");
            else
                $("#slider #genre_headings").html("Close Friends<br/>Similar Interests<br/>");
            */
         }
    });
	//top container done
	
	$.get("{% url visualizor.views.tagcloud %}", function(returned_html) {
		$("#default_tag_cloud").html(returned_html);
		$("#default_tag_cloud a").click(function(){
		    var loadingsign = "<li style='text-align:center'><span><img src='{{ STATIC_URL }}images/loading.gif' style='border:none' /> Loading... </span></li>";
            $("#default_items_list").html(loadingsign);
		    $.get("{% url recommender.views.showItem %}", {'id':this.id.substring(2),'name': $(this).text(),'category': $(this).attr('name')}, function(returned_html) {
                $("#default_items_list").html(returned_html);
                powerItemButtons($("#default_items_list div"),false);
                $("#log").show();
                if (typeof FB !== 'undefined') {
                    FB.XFBML.parse(document.getElementById('default_items_list'));
                }
                $('.stars-wrapper2').raty({
                    path: '{{ STATIC_URL}}images/ratings/',
                    half: true,
                    hintList: ['bad', 'poor', 'regular', 'good', 'brilliant'],
                    click: function(score, evt) {
                        //alert("Yo");
                        ;
                    }
                });
            });
	    });
	});
	
		
	$( "#genre_slider > div" ).each(function() {
		// read initial values from markup and remove that
		var value = parseInt( $( this ).text(), 10 );
		$( this ).empty().slider({
			value: value,
			range: "min",
			animate: true,
			change: function( event, ui) {
			    
		        config = getCurrentConfig({algorithm: "random"});
			    showUpdatedItems(config);
			}
		});
	});
	$( "#people_slider > div" ).each(function() {
		// read initial values from markup and remove that
		var value = parseInt( $( this ).text(), 10 );
		$( this ).empty().slider({
			value: value,
			range: "min",
			animate: true,
			change: function( event, ui) {
			    
			    config = getCurrentConfig({algorithm: "random"});
			    showUpdatedItems(config);
			    
			}
		});
	});
	
    config = getCurrentConfig({});
    showUpdatedItems(config);
    
   
	$("#Qbutton").click (function() {
	    config = getCurrentConfig({algorithm:"queue"});
        showUpdatedItems(config);
        $("#back_to_recs").show();
	});
	
	$( "#queue_area" ).droppable({
		accept: "#default_items_list > li",
		hoverClass: "ui-state-hover",
		//activeClass: "ui-state-hover",
		drop: function( event, ui ) {
		    var li_element = ui.draggable;
		    var pic_url=li_element.children('div.item-poster:first').css('background-image');
            pic_url = pic_url.substring(4,pic_url.length-1);
            item_type = li_element.children('div.item-poster:first').attr('name');
			$( this )
				.addClass( "ui-state-highlight" );
				//.html( "Dropped!");
			 $.get("{% url base.realtime.addtoQueue %}", {'item_id': li_element.children('a:last').attr('name'), 'item_link':li_element.children('a:last').attr('href'), 'item_name':li_element.children('a:last').text(), 'item_pic':pic_url,'item_type':item_type}, function(resp) {
			            if (resp == "1") {
			                $( "#queue-confirm" ).dialog('open');
			            }
			        });
		    $( "#queue-confirm" ).dialog('open');
			ui.draggable.hide();
		}
	});
	
	var msg_input = $( "#message" ),
			allFields = $( [] ).add( msg_input );
		
	$('#suggest_dialog').dialog({
	    autoOpen: false,
	    width: 300,
	    buttons: {
					"Share": function() {
						var bValid = true;
						allFields.removeClass( "ui-state-error" );

						bValid = bValid && checkLength( msg_input, "message", 1, 250 );

						if ( bValid ) {
							//Post to profile
							//$item_info = $('#log-content').children().first();
							item_info = $(this).data('item_info');
							var item_id = item_info['id'];
							//alert(item_info['name'] + item_info['link']);
							//alert(item_info['picture']);
							var postObj={
									message: msg_input.val(),
									name: item_info['name'],
					                link: item_info['link'],
					                picture: item_info['picture'],
					                caption: item_info['caption'],
					                description: '',
									actions: {name: 'View it on Pop Core', link: 'http://apps.facebook.com/popcore'}
								};

							$('#suggest_dialog .friends > span').each(function(index){
								var fr_id = $(this).attr('id');
								//alert(fr_id);
								
								$.get("{% url base.realtime.addSuggestion %}", {'item_id':item_id, 'target':fr_id, 'message': msg_input.val()}, function(resp) {
                                    //alert(resp);
                                    if (resp == '0'){
                                        $( "#dialog_sharefb" ).dialog({
			                                resizable: false,
			                                height:200,
			                                buttons: {
				                                "Share on wall": function() {
				                                    FB.api('/'+fr_id+'/feed', 'post', postObj, function(response) {
									                     if (!response || response.error) {
										                     alert('Error occured' + JSON.stringify(response.error));
									                     } else {
							                      			alert('Post ID: ' + response.id);
									                     }
								                    });
					                                $( this ).dialog( "close" );
				                                },
				                                Cancel: function() {
					                                $( this ).dialog( "close" );
				                                }
			                                }
		                                });
                                    }
                                });
							});
							
							
							$( this ).dialog( "close" );
						}
					},
					Cancel: function() {
						$( this ).dialog( "close" );
					}
				},
			close: function() {
					allFields.val( "" ).removeClass( "ui-state-error" );
					$(".remove").trigger('click');
				},
		    open: function(event, ui) {
		            var item_info =$(this).data('item_info');
		            var fr_id = item_info['fr_id'];
		            var friend = item_info['friend'];
		            //alert(fr_id+friend);
		            if (friend != "More...") {
	                    var span = $("<span>").attr('id', fr_id).addClass('ui-state-highlight ui-widget-content ui-corner-all').css('margin','5px').css('padding','2px').text(friend);
	                    var a = $("<a>").addClass("remove").attr({
		                    href: "javascript:",
		                    title: "Remove " + friend
	                    }).text("x").appendTo(span);

	                    //add friend to friend div
	                    span.insertBefore($("#suggest_dialog .to").filter(":first"));
	                }
                },
			show: 'blind',
			hide: 'blind',
			closeText: 'Skip'
	});
	
	//add click handler to friends div
	$(".friends").live("click", function(){
		//focus 'to' field
		$(this).children('input').first().focus();
	});
	
	//add live handler for clicks on remove links
	$(".remove").live("click", function(){
	
		//remove current friend
		$(this).parent().remove();
		
		//correct 'to' field position
		/*TODO: correct this when we have multiple friend suggest boxes
		if($(".friends span").length === 0) {
			$(".to").css("top", 0);
		}				*/
		if($(this).parent().length === 0) {
			$(".to").css("top", 0);
		}	
	});
	
	
	$('#searchbar #search').focus(function(){
				if ($(this).val() == "Search stuff...")
					$(this).val("");
	});
	
	friends_list = "{{ friends_json }}"
	//autocomplete for friend completer
	$('.to').autocomplete({
   				source: jQuery.parseJSON(friends_list.replace(/&quot;/g, "\"")),
   				//define select handler
   				select: function(e, ui) {
   					insertFormattedFriend($(this),ui);
   					$(this).val("");
   					//alert($(this).val());
   					//create formatted friend
    				},
   				//define select handler
   				change: function() {
   					//prevent 'to' field being updated and correct position
   					$(this).val("").css("top", 2);
   				}
   	});
   
	//autocomplete for search items
	var cache = {}, lastXhr;		
	$( "#searchbar #search" ).autocomplete({
			minLength:3,
			delay: 300,
			source: function( request, response ) {
			            $("#searchbar .throbber").show();
						var term = request.term;
						if ( term in cache ) {
							response( cache[ term ] );
							return;
						}

						lastXhr = $.getJSON( "{% url recommender.views.search %}", { query: request.term }, function(data, status, xhr) {
																		cache[ term ] = data;
																		if ( xhr === lastXhr ) {
																			response( data );
																		}
																		$("#searchbar .throbber").hide();
																	});
					},
			select: function( event, ui ) {
			            var loadingsign = "<li style='text-align:center'><span><img src='{{ STATIC_URL }}images/loading.gif' style='border:none' /> Loading... </span></li>";
	                    $("#default_items_list").html(loadingsign);
						$.get("{% url recommender.views.showItem %}", {'id':ui.item.id,'name': ui.item.label,'category': ui.item.category}, function(returned_html) {
						    showItemInMainScreen(returned_html);
		                    
	                    });
						
					},
			open: 	function() {
						$( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
					},
			close: 	function() {
						$( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
					}
		}).data( "autocomplete" )._renderItem = function( ul, item ) {
		                                            //alert(item.label);
													return $( "<li></li>" ).data( "item.autocomplete", item )
																.append( "<a><span class='bold-text'>" + item.label + "</span><br>" + item.category + "</a>" ).appendTo( ul );
												};
   $.widget( "custom.catcomplete", $.ui.autocomplete, {
		_renderMenu: function( ul, items ) {
			var self = this,
				currentCategory = "";
			$.each( items, function( index, item ) {
				if ( item.category != currentCategory ) {
					ul.append( "<li class='ui-autocomplete-category'>" + item.category + "</li>" );
					currentCategory = item.category;
				}
				self._renderItem( ul, item );
			});
		}
	});
	
	$( "#queue-confirm" ).dialog({
			modal: true,
			autoOpen: false,
			buttons: {
				Ok: function() {
					$( this ).dialog( "close" );
				}
			}
    });
    
    $('.notification-icon').click (function (event){
        alert("Yo1");
    });
    
    $('.profile-icon').click (function (event){
     alert("Yo");
    });
    
    poll();
    setInterval('poll()',10000);
    $('#nowknob1').click(function(){
        $('#recency_chooser').speedometer({percentage:30});
        $('#recency_chooser').data('recency',"old");
        config = getCurrentConfig({recency:"old"});
	    showUpdatedItems(config);
    });
    $('#nowknob2').click(function(){
        $('#recency_chooser').speedometer({percentage:50});
        $('#recency_chooser').data('recency',"now");
        config = getCurrentConfig({recency:"now"});
	    showUpdatedItems(config);
    });
    $('#nowknob3').click(function(){
        $('#recency_chooser').speedometer({percentage:70});
        $('#recency_chooser').data('recency',"future");
        /*$( "#dialog_notimplemented" ).dialog({
			resizable: false,
			height:170,
			buttons: {
				"Okay": function() {
					$( this ).dialog( "close" );
				}
				
			}
		});*/
        config = getCurrentConfig({recency:"future"});
	    showUpdatedItems(config);
    });
    	    
	
});
</script>
<script src="{{ STATIC_URL }}js/facebook.js" type="text/javascript"></script>
<!--<script src="{{ STATIC_URL}}js/statictest.js" type="text/javascript"></script>-->
<script src="{{ STATIC_URL }}js/jquery.speedometer.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/jquery.jqcanvas-modified.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}js/excanvas-modified.js" type="text/javascript"></script>

<script>
	facebookAppId = '{{ FACEBOOK_APP_ID }}';
	function facebookJSLoaded(){
	    //alert(facebookAppId);
		FB.init({appId: facebookAppId, status: true, cookie: true, xfbml: true, oauth: true});
		//resizing and removing the ugly scroll bars
		FB.Canvas.setAutoGrow();
		
		/* All the events registered */
	    FB.Event.subscribe('auth.login', function(response) {
	         // do something with response
	         //alert("Logged in");
	     	 // whenever the user logs in, we refresh the page
	         //window.location.reload();
	    });
	    FB.Event.subscribe('auth.logout', function(response) {
	         // do something with response
	     	sendAJAXCloseEvent();
	    });

	 	FB.Event.subscribe('edge.create', function(href, widget){
		 	//alert("You liked "+ href);
		 	//console.log(widget);
			var item_id = $(widget['dom']).parent().attr('id');
			$.ajax({
				url: "record_user_feedback.php", 
				data: {'action': 'like', 'item_id': item_id, 'uid':1234},
				cache: false
			});
			
	 	});

	 	FB.Event.subscribe('edge.remove', function(href, widget){
		 	//alert("You unliked "+ href);
		 	var item_id = $(widget['dom']).parent().attr('id');
			$.ajax({
				url: "record_user_feedback.php", 
				data: {'action': 'unlike', 'item_id': item_id, 'uid':1234},
				cache: false
			});
	 	});
	 	
	 	/*
	    FB.Event.subscribe('auth.authResponseChange', function(response) {
            //window.location.reload();
        });*/
        /*
        FB.getLoginStatus(function(response) {
            if (response.status == "connected") {
                // logged in and connected user, someone you know
                ;
              } else {
                ;
              }
        });*/
	}
	window.fbAsyncInit = facebookJSLoaded;
	
	F = new facebookClass(facebookAppId);
    F.load();
    //alert("YO");
    /*FB.api('/platform', function(response) {
  alert(response.company_overview);
});*/
	
</script>
<script id="_webengage_script_tag" type="text/javascript">
  window.webengageWidgetInit = window.webengageWidgetInit || function(){
    webengage.init({
      licenseCode:"~15ba20640"
    }).onReady(function(){
      webengage.render();
    });
  };

  (function(d){
    var _we = d.createElement('script');
    _we.type = 'text/javascript';
    _we.async = true;
    _we.src = (d.location.protocol == 'https:' ? "//ssl.widgets.webengage.com" : "//cdn.widgets.webengage.com") + "/js/widget/webengage-min-v-3.0.js";
    var _sNode = d.getElementById('_webengage_script_tag');
    _sNode.parentNode.insertBefore(_we, _sNode);
  })(document);
</script>
</body>
</html>

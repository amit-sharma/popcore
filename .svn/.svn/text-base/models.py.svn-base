from django.db import models
from django_facebook.models import FacebookProfileModel
from django.contrib.auth.models import User
from django.conf import settings 

# Create your models here.
# Model for a user. Inherits from a FacebookProfileModel defined in djangoFacebook.
class UserProfile(FacebookProfileModel):
    '''
    Inherit the properties from django facebook
    '''
    user = models.OneToOneField(User)

# Model for a human-to-human suggestion
class Suggestion(models.Model):
    source_user = models.CharField(max_length=31)
    target_user = models.CharField(max_length=31)
    item_id = models.CharField(max_length=31)
    message = models.CharField(max_length=1023)
    isnew = models.BooleanField()
    created_time = models.DateTimeField(auto_now_add=True)
    app_name=models.CharField(max_length=7,default=settings.POPCORE_APP_NAME)

#Model for item rating
class ItemRating(models.Model):
    source_user = models.CharField(max_length=31)
    item_id = models.CharField(max_length=31)
    rating = models.FloatField()
    created_time = models.DateTimeField(auto_now_add=True)
    app_name=models.CharField(max_length=7,default=settings.POPCORE_APP_NAME)
    #unique_together = ('source_user','item_id')
    
# Model for an item in the queue of a user
class QueueItem(models.Model):
    source_user = models.CharField(max_length=31)
    item_type = models.CharField(max_length=31)
    item_id = models.CharField(max_length=31)
    item_link = models.TextField(null=True) 
    item_pic = models.TextField(null=True)
    item_name = models.TextField( null=True)
    created_time = models.DateTimeField(auto_now_add=True)
    app_name=models.CharField(max_length=7,default=settings.POPCORE_APP_NAME)

# Keeps the activities of a user on the server
class ActivityLog(models.Model):
    source_user = models.CharField(max_length=31)
    activity = models.CharField(max_length=31)
    data = models.CharField(max_length=63, blank=True)
    created_time = models.DateTimeField(auto_now_add=True)
    app_name=models.CharField(max_length=7,default=settings.POPCORE_APP_NAME)

        
from django.db.models.signals import post_save
from django.dispatch import receiver

#These are to denote the runtime state of a user
class RuntimeFlags(models.Model):
    user = models.CharField(max_length=31, primary_key=True)
    tasks_barrier = models.SmallIntegerField()
    needs_update = models.BooleanField(default=True)
    app_name=models.CharField(max_length=7,default=settings.POPCORE_APP_NAME)

#helper function    
@receiver(post_save, sender=User)
def create_profile(sender, instance, created, **kwargs):
    """Create a matching profile whenever a user object is created."""
    if created: 
        profile, new = UserProfile.objects.get_or_create(user=instance)
